package io.quarkiverse.langchain4j.evaluation.junit5.it;

import static org.assertj.core.api.Assertions.assertThat;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;
import org.junit.jupiter.api.extension.ExtendWith;

import io.quarkiverse.langchain4j.evaluation.junit5.EvaluationExtension;
import io.quarkiverse.langchain4j.evaluation.junit5.ReportConfiguration;
import io.quarkiverse.langchain4j.evaluation.junit5.SampleLocation;
import io.quarkiverse.langchain4j.testing.evaluation.EvaluationReport;
import io.quarkiverse.langchain4j.testing.evaluation.EvaluationResult;
import io.quarkiverse.langchain4j.testing.evaluation.Samples;
import io.quarkiverse.langchain4j.testing.evaluation.Scorer;
import io.quarkus.test.junit.QuarkusTest;

/**
 * Integration test verifying that @ReportConfiguration works correctly with Quarkus test instances.
 */
@QuarkusTest
@ExtendWith(EvaluationExtension.class)
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class ReportConfigurationQuarkusIT {

    private static final String OUTPUT_DIR = "target/report-config-test";

    // This report should be automatically generated by EvaluationExtension
    @ReportConfiguration(outputDir = OUTPUT_DIR, formats = { "markdown",
            "json" }, fileName = "auto-generated-report", includeDetails = true, pretty = true)
    private EvaluationReport<String> autoGeneratedReport;

    // This report should also be automatically generated with different settings
    @ReportConfiguration(outputDir = OUTPUT_DIR, formats = {
            "json" }, fileName = "minimal-report", includeDetails = false, pretty = false)
    private EvaluationReport<String> minimalReport;

    @BeforeAll
    static void cleanupOutputDir() throws IOException {
        Path outputDir = Paths.get(OUTPUT_DIR);
        if (Files.exists(outputDir)) {
            Files.walk(outputDir)
                    .sorted((a, b) -> b.compareTo(a)) // Delete files before directories
                    .forEach(path -> {
                        try {
                            Files.deleteIfExists(path);
                        } catch (IOException e) {
                            // Ignore
                        }
                    });
        }
    }

    @Test
    void shouldCreateReportForAutomaticGeneration(
            Scorer scorer,
            @SampleLocation("src/test/resources/test-samples.yaml") Samples<String> samples) {

        // Create a report and assign it to the @ReportConfiguration field
        autoGeneratedReport = scorer.evaluate(samples,
                params -> params.<String> get(0),
                (sample, actual) -> EvaluationResult.fromBoolean(
                        sample.expectedOutput().equals(actual)));

        // Verify report was created
        assertThat(autoGeneratedReport).isNotNull();
        assertThat(autoGeneratedReport.evaluations()).isNotEmpty();
    }

    @Test
    void shouldCreateMinimalReportForAutomaticGeneration(
            Scorer scorer,
            @SampleLocation("src/test/resources/test-samples.yaml") Samples<String> samples) {

        Samples<String> limitedSamples = new io.quarkiverse.langchain4j.testing.evaluation.Samples<>(
                samples.subList(0, 1));

        minimalReport = scorer.evaluate(limitedSamples,
                params -> params.<String> get(0),
                (sample, actual) -> EvaluationResult.fromBoolean(
                        sample.expectedOutput().equals(actual)));

        assertThat(minimalReport).isNotNull();
        assertThat(minimalReport.evaluations()).hasSize(1);

        System.out.println("Created minimalReport with " + minimalReport.evaluations().size() + " evaluations");
    }

    @AfterAll
    void verifyReportsWereCaptured() {
        // At this point, the report fields should be populated
        // The actual file generation happens in EvaluationExtension.afterAll()
        // which runs AFTER this method (in Quarkus test lifecycle)

        assertThat(autoGeneratedReport)
                .as("Auto-generated report should be captured")
                .isNotNull();

        assertThat(autoGeneratedReport.evaluations())
                .as("Auto-generated report should contain evaluations")
                .isNotEmpty();

        assertThat(minimalReport)
                .as("Minimal report should be captured")
                .isNotNull();

        assertThat(minimalReport.evaluations())
                .as("Minimal report should contain exactly 1 evaluation")
                .hasSize(1);
    }
}
